language: go
sudo: required
services:
- docker
go:
- 1.9

env:
  - DEP_VERSION="0.4.1"

before_install:
  # Download the binary to bin folder in $GOPATH
  - curl -L -s https://github.com/golang/dep/releases/download/v${DEP_VERSION}/dep-linux-amd64 -o $GOPATH/bin/dep
  # Make the binary executable
  - chmod +x $GOPATH/bin/dep

jobs:
  include:
  - stage: test
    script:
    - dep ensure
    - go test -v ./...
  - stage: build docker image
    script:
    - export VERSION_NUMBER=$(git describe --tags --always)
    - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
    - docker build -t aoepeople/gitlab-crucible-bridge:$VERSION_NUMBER .
    - docker push aoepeople/gitlab-crucible-bridge:$VERSION_NUMBER
  - stage: release on github
    script:
    - ./build.sh
    deploy: 
      provider: releases
      api_key:
        secure: $GITHUB_TOKEN
      file_glob: true
      file: gitlab-crucible-bridge-*  
      skip_cleanup: true
      on:
        tags: true